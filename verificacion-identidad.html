<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Verificación de Identidad - RIFAS UBIA</title>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/dashboard.css">
    <link rel="stylesheet" href="css/responsive.css">
    <!-- verificacion.css debe cargarse DESPUÉS de dashboard.css para sobrescribir estilos -->
    <link rel="stylesheet" href="css/verificacion.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Inline styles to ensure verification page layout is correct */
        body.verification-page.dashboard-body {
            display: block !important;
        }
        body.verification-page .dashboard-main {
            margin-left: 0 !important;
            width: 100% !important;
            max-width: 1200px !important;
            margin: 0 auto !important;
        }
        body.verification-page .dashboard-header {
            width: 100% !important;
            max-width: 1200px !important;
            margin: 0 auto !important;
        }
        body.verification-page .menu-toggle {
            display: none !important;
        }
    </style>
</head>
<body class="dashboard-body verification-page">
    <!-- Header -->
    <header class="dashboard-header">
        <div class="header-left">
            <button class="menu-toggle" id="menuToggle">
                <i class="fas fa-bars"></i>
            </button>
            <h1><i class="fas fa-id-card"></i> Verificación de Identidad</h1>
        </div>
        <div class="header-right">
            <a href="index.html" class="btn btn-outline">
                <i class="fas fa-home"></i> Inicio
            </a>
        </div>
    </header>

    <!-- Main Content -->
    <main class="dashboard-main">
        <!-- Verification Status Banner -->
        <div class="verification-banner" id="verificationBanner">
            <!-- Se llenará dinámicamente -->
        </div>

        <!-- Security Notice -->
        <div class="security-notice-verification">
            <div class="security-notice-content">
                <i class="fas fa-shield-alt"></i>
                <div>
                    <strong>Seguridad de tus Datos</strong>
                    <p>Todos tus datos personales están completamente encriptados con <strong>AES-256</strong> (nivel bancario) y protegidos conforme al <strong>RGPD/GDPR</strong>. Nadie puede acceder a ellos sin tu autorización explícita, excepto en casos excepcionales requeridos por orden judicial o autoridad competente legalmente autorizada. <a href="politica-privacidad.html#seguridad" style="color: var(--primary-color); text-decoration: underline;">Más información</a></p>
                </div>
            </div>
        </div>

        <!-- Verification Steps -->
        <section class="verification-section">
            <div class="verification-header">
                <h2>Completa tu Verificación de Identidad</h2>
                <p>Para garantizar la seguridad y cumplir con las normativas, necesitamos verificar tu identidad. Este proceso es obligatorio para participar en rifas y retirar premios.</p>
            </div>

            <!-- Progress Bar -->
            <div class="verification-progress">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                </div>
                <p class="progress-text" id="progressText">0% Completado</p>
            </div>

            <!-- Verification Steps Container -->
            <div class="verification-steps-container">
                
                <!-- Step 1: Email Verification -->
                <div class="verification-step" id="stepEmail">
                    <div class="step-header">
                        <div class="step-number">1</div>
                        <div class="step-info">
                            <h3>Verificación de Correo Electrónico</h3>
                            <p>Confirma tu dirección de correo electrónico</p>
                        </div>
                        <div class="step-status" id="statusEmail">
                            <i class="fas fa-clock"></i> Pendiente
                        </div>
                    </div>
                    <div class="step-content">
                        <div class="verification-form">
                            <p><strong>Email registrado:</strong> <span id="userEmail"></span></p>
                            <button class="btn btn-primary" onclick="sendEmailVerification()">
                                <i class="fas fa-envelope"></i> Enviar Código de Verificación
                            </button>
                            <div id="emailCodeSection" style="display: none; margin-top: 1rem;">
                                <input type="text" id="emailCode" class="form-control" placeholder="Ingresa el código de 6 dígitos" maxlength="6">
                                <button class="btn btn-primary" onclick="verifyEmailCode()" style="margin-top: 0.5rem;">
                                    <i class="fas fa-check"></i> Verificar Código
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Step 2: Phone Verification -->
                <div class="verification-step" id="stepPhone">
                    <div class="step-header">
                        <div class="step-number">2</div>
                        <div class="step-info">
                            <h3>Verificación de Teléfono</h3>
                            <p>Confirma tu número de teléfono</p>
                        </div>
                        <div class="step-status" id="statusPhone">
                            <i class="fas fa-clock"></i> Pendiente
                        </div>
                    </div>
                    <div class="step-content">
                        <div class="verification-form">
                            <div class="form-group">
                                <label>Número de Teléfono</label>
                                <input type="tel" id="phoneNumber" class="form-control" placeholder="+34 627 039 947" maxlength="15">
                                <small>Incluye el código de país (ej: +34)</small>
                            </div>
                            <button class="btn btn-primary" onclick="sendPhoneVerification()">
                                <i class="fas fa-sms"></i> Enviar Código SMS
                            </button>
                            <div id="phoneCodeSection" style="display: none; margin-top: 1rem;">
                                <input type="text" id="phoneCode" class="form-control" placeholder="Ingresa el código de 6 dígitos" maxlength="6">
                                <button class="btn btn-primary" onclick="verifyPhoneCode()" style="margin-top: 0.5rem;">
                                    <i class="fas fa-check"></i> Verificar Código
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Step 3: Document Scan -->
                <div class="verification-step" id="stepDocument">
                    <div class="step-header">
                        <div class="step-number">3</div>
                        <div class="step-info">
                            <h3>Escaneo de Documento de Identidad</h3>
                            <p>Sube una foto clara de tu DNI, pasaporte o documento de identidad</p>
                        </div>
                        <div class="step-status" id="statusDocument">
                            <i class="fas fa-clock"></i> Pendiente
                        </div>
                    </div>
                    <div class="step-content">
                        <div class="verification-form">
                            <!-- Document Data Form -->
                            <div class="document-data-form" id="documentDataForm">
                                <h4 style="margin-bottom: 1rem; color: var(--text-primary);">Ingresa los datos de tu documento</h4>
                                <div class="form-grid" style="grid-template-columns: 1fr 1fr; gap: 1rem;">
                                    <div class="form-group">
                                        <label>Tipo de Documento *</label>
                                        <select id="documentType" class="form-control" required>
                                            <option value="">Selecciona el tipo</option>
                                            <option value="DNI">DNI (España)</option>
                                            <option value="NIE">NIE (España)</option>
                                            <option value="Pasaporte">Pasaporte</option>
                                            <option value="Cedula">Cédula</option>
                                            <option value="Licencia">Licencia de Conducir</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label>Número de Documento *</label>
                                        <input type="text" id="documentNumber" class="form-control" placeholder="12345678X" required>
                                    </div>
                                    <div class="form-group">
                                        <label>Nombre *</label>
                                        <input type="text" id="documentFirstName" class="form-control" placeholder="Nombre" required>
                                    </div>
                                    <div class="form-group">
                                        <label>Apellidos *</label>
                                        <input type="text" id="documentLastName" class="form-control" placeholder="Apellidos" required>
                                    </div>
                                    <div class="form-group">
                                        <label>Fecha de Nacimiento *</label>
                                        <input type="date" id="documentBirthDate" class="form-control" required>
                                    </div>
                                    <div class="form-group">
                                        <label>Nacionalidad *</label>
                                        <input type="text" id="documentNationality" class="form-control" placeholder="Española" required>
                                    </div>
                                </div>
                                <button class="btn btn-primary" onclick="startDocumentScan()" style="margin-top: 1rem;">
                                    <i class="fas fa-camera"></i> Continuar con Escaneo del Documento
                                </button>
                            </div>

                            <!-- Document Scan Area -->
                            <div class="document-scan-area" id="documentScanArea" style="display: none;">
                                <div class="scan-instructions">
                                    <i class="fas fa-info-circle"></i>
                                    <p>Coloca tu documento dentro del marco. Asegúrate de que se vea completo y nítido.</p>
                                </div>
                                <div class="document-camera-container">
                                    <video id="documentVideo" autoplay playsinline style="display: none; width: 100%; max-width: 600px; border-radius: var(--radius-md);"></video>
                                    <canvas id="documentCanvas" style="display: none;"></canvas>
                                    <div class="document-overlay" id="documentOverlay" style="display: none;">
                                        <div class="document-guide-frame" id="documentGuideFrame"></div>
                                        <div class="document-quality-indicator" id="documentQualityIndicator">
                                            <i class="fas fa-check-circle"></i>
                                            <span>Documento bien encuadrado</span>
                                        </div>
                                    </div>
                                    <div class="document-placeholder" id="documentPlaceholder">
                                        <i class="fas fa-id-card"></i>
                                        <p>Preparando cámara...</p>
                                    </div>
                                </div>
                                <div class="document-capture-controls" id="documentCaptureControls" style="display: none;">
                                    <button class="btn btn-outline" onclick="stopDocumentScan()">
                                        <i class="fas fa-times"></i> Cancelar
                                    </button>
                                    <button class="btn btn-primary btn-large" onclick="captureDocument()">
                                        <i class="fas fa-camera"></i> Capturar Documento
                                    </button>
                                </div>
                            </div>

                            <!-- Document Preview and Verification -->
                            <div id="documentPreview" style="display: none;">
                                <div class="document-preview-container">
                                    <h4 style="margin-bottom: 1rem;">Vista Previa del Documento</h4>
                                    <img id="documentPreviewImg" src="" alt="Vista previa del documento" style="width: 100%; max-width: 600px; border-radius: var(--radius-md); border: 2px solid var(--border-light);">
                                </div>
                                
                                <!-- Data Verification Results -->
                                <div class="document-verification-results" id="documentVerificationResults" style="display: none;">
                                    <h4 style="margin-bottom: 1rem; color: var(--text-primary);">Verificación de Datos</h4>
                                    <div class="verification-comparison-table" id="verificationComparisonTable">
                                        <!-- Se llenará dinámicamente -->
                                    </div>
                                </div>
                                
                                <div class="preview-actions" style="margin-top: 1.5rem;">
                                    <button class="btn btn-outline" onclick="retakeDocument()">
                                        <i class="fas fa-redo"></i> Volver a Escanear
                                    </button>
                                    <button class="btn btn-primary" id="submitDocumentBtn" onclick="verifyDocumentData()" disabled>
                                        <i class="fas fa-check"></i> Verificar y Confirmar
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Step 4: Selfie with Document -->
                <div class="verification-step" id="stepSelfie">
                    <div class="step-header">
                        <div class="step-number">4</div>
                        <div class="step-info">
                            <h3>Selfie con Documento</h3>
                            <p>Sostén tu documento junto a tu cara y toma una selfie</p>
                        </div>
                        <div class="step-status" id="statusSelfie">
                            <i class="fas fa-clock"></i> Pendiente
                        </div>
                    </div>
                    <div class="step-content">
                        <div class="verification-form">
                            <div class="selfie-instructions">
                                <div class="instruction-item">
                                    <i class="fas fa-check-circle"></i>
                                    <span>Sostén tu documento junto a tu cara</span>
                                </div>
                                <div class="instruction-item">
                                    <i class="fas fa-check-circle"></i>
                                    <span>Asegúrate de que tu rostro y el documento sean claramente visibles</span>
                                </div>
                                <div class="instruction-item">
                                    <i class="fas fa-check-circle"></i>
                                    <span>Buena iluminación y sin reflejos</span>
                                </div>
                            </div>
                            <div class="selfie-capture-area" id="selfieCaptureArea">
                                <video id="selfieVideo" autoplay playsinline style="display: none;"></video>
                                <canvas id="selfieCanvas" style="display: none;"></canvas>
                                <div class="camera-placeholder" id="cameraPlaceholder">
                                    <i class="fas fa-camera"></i>
                                    <button class="btn btn-primary" onclick="startSelfieCapture()">
                                        <i class="fas fa-video"></i> Iniciar Cámara
                                    </button>
                                </div>
                                <div id="selfiePreview" style="display: none;">
                                    <img id="selfiePreviewImg" src="" alt="Vista previa de selfie">
                                    <div class="preview-actions">
                                        <button class="btn btn-outline" onclick="retakeSelfie()">
                                            <i class="fas fa-redo"></i> Volver a Tomar
                                        </button>
                                        <button class="btn btn-primary" onclick="submitSelfie()">
                                            <i class="fas fa-check"></i> Confirmar Selfie
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Step 5: Facial Recognition -->
                <div class="verification-step" id="stepFacial">
                    <div class="step-header">
                        <div class="step-number">5</div>
                        <div class="step-info">
                            <h3>Reconocimiento Facial</h3>
                            <p>Escaneo facial para verificar tu identidad</p>
                        </div>
                        <div class="step-status" id="statusFacial">
                            <i class="fas fa-clock"></i> Pendiente
                        </div>
                    </div>
                    <div class="step-content">
                        <div class="verification-form">
                            <!-- Facial Scan Progress Steps -->
                            <div class="facial-scan-progress" id="facialScanProgress" style="display: none;">
                                <div class="scan-steps-indicator">
                                    <div class="scan-step" data-step="0">
                                        <div class="step-circle">1</div>
                                        <span>Al frente</span>
                                    </div>
                                    <div class="scan-step" data-step="1">
                                        <div class="step-circle">2</div>
                                        <span>Izquierda</span>
                                    </div>
                                    <div class="scan-step" data-step="2">
                                        <div class="step-circle">3</div>
                                        <span>Derecha</span>
                                    </div>
                                    <div class="scan-step" data-step="3">
                                        <div class="step-circle">4</div>
                                        <span>Arriba</span>
                                    </div>
                                    <div class="scan-step" data-step="4">
                                        <div class="step-circle">5</div>
                                        <span>Abajo</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Active Scan Instructions -->
                            <div class="facial-scan-active-instructions" id="facialActiveInstructions" style="display: none;">
                                <div class="instruction-guide">
                                    <div class="instruction-icon" id="facialInstructionIcon">
                                        <i class="fas fa-arrow-up"></i>
                                    </div>
                                    <h3 id="facialInstructionText">Mira directamente a la cámara</h3>
                                    <p id="facialInstructionSubtext">Mantén la posición hasta que se capture la imagen</p>
                                    <div class="countdown-timer" id="facialCountdown" style="display: none;">
                                        <span id="countdownNumber">3</span>
                                    </div>
                                </div>
                            </div>

                            <div class="facial-scan-instructions" id="facialInitialInstructions">
                                <div class="instruction-item">
                                    <i class="fas fa-info-circle"></i>
                                    <span>Deberás mover tu rostro en diferentes direcciones</span>
                                </div>
                                <div class="instruction-item">
                                    <i class="fas fa-check-circle"></i>
                                    <span>El escaneo capturará 5 posiciones diferentes</span>
                                </div>
                                <div class="instruction-item">
                                    <i class="fas fa-check-circle"></i>
                                    <span>Asegúrate de tener buena iluminación</span>
                                </div>
                            </div>
                            <div class="facial-scan-area" id="facialScanArea">
                                <video id="facialVideo" autoplay playsinline style="display: none; width: 100%; max-width: 500px; border-radius: var(--radius-md);"></video>
                                <canvas id="facialCanvas" style="display: none;"></canvas>
                                <div class="facial-overlay" id="facialOverlay" style="display: none;">
                                    <div class="face-guide-box" id="faceGuideBox"></div>
                                </div>
                                <div class="scan-placeholder" id="scanPlaceholder">
                                    <i class="fas fa-user-circle"></i>
                                    <button class="btn btn-primary" onclick="startFacialScan()">
                                        <i class="fas fa-video"></i> Iniciar Escaneo Facial Activo
                                    </button>
                                    <p style="margin-top: 1rem; color: var(--text-secondary); font-size: 0.875rem;">
                                        Requerirás mover tu rostro en diferentes direcciones
                                    </p>
                                </div>
                                <div id="facialPreview" style="display: none;">
                                    <div class="facial-captures-grid" id="facialCapturesGrid"></div>
                                    <div class="preview-actions">
                                        <button class="btn btn-outline" onclick="retakeFacial()">
                                            <i class="fas fa-redo"></i> Volver a Escanear
                                        </button>
                                        <button class="btn btn-primary" onclick="submitFacialScan()">
                                            <i class="fas fa-check"></i> Confirmar Escaneo Completo
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Step 6: Bank Account Verification -->
                <div class="verification-step" id="stepBank">
                    <div class="step-header">
                        <div class="step-number">6</div>
                        <div class="step-info">
                            <h3>Verificación de Cuenta Bancaria</h3>
                            <p>Verifica tu cuenta bancaria para recibir premios</p>
                        </div>
                        <div class="step-status" id="statusBank">
                            <i class="fas fa-clock"></i> Pendiente
                        </div>
                    </div>
                    <div class="step-content">
                        <div class="verification-form">
                            <div class="form-group">
                                <label>Tipo de Cuenta</label>
                                <select id="accountType" class="form-control">
                                    <option value="">Selecciona el tipo</option>
                                    <option value="checking">Cuenta Corriente</option>
                                    <option value="savings">Cuenta de Ahorros</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Banco</label>
                                <input type="text" id="bankName" class="form-control" placeholder="Nombre del banco">
                            </div>
                            <div class="form-group">
                                <label>Número de Cuenta (IBAN)</label>
                                <input type="text" id="accountNumber" class="form-control" placeholder="ES91 2100 0418 4502 0005 1332" maxlength="34">
                                <small>Formato: IBAN (ej: ES91 2100 0418 4502 0005 1332)</small>
                            </div>
                            <div class="form-group">
                                <label>Nombre del Titular</label>
                                <input type="text" id="accountHolder" class="form-control" placeholder="Nombre completo del titular">
                            </div>
                            <div class="form-group">
                                <label>Documento de Identidad del Titular</label>
                                <input type="text" id="accountHolderDoc" class="form-control" placeholder="DNI/NIE del titular">
                            </div>
                            <button class="btn btn-primary" onclick="verifyBankAccount()">
                                <i class="fas fa-university"></i> Verificar Cuenta Bancaria
                            </button>
                            <div id="bankVerificationStatus" style="margin-top: 1rem;"></div>
                        </div>
                    </div>
                </div>

                <!-- Step 7: Credit Card Verification -->
                <div class="verification-step" id="stepCard">
                    <div class="step-header">
                        <div class="step-number">7</div>
                        <div class="step-info">
                            <h3>Verificación de Tarjeta Bancaria</h3>
                            <p>Verifica tu tarjeta de débito o crédito para facilitar los pagos</p>
                        </div>
                        <div class="step-status" id="statusCard">
                            <i class="fas fa-clock"></i> Pendiente
                        </div>
                    </div>
                    <div class="step-content">
                        <div class="verification-form">
                            <div class="form-group">
                                <label>Tipo de Tarjeta</label>
                                <select id="cardType" class="form-control" onchange="detectCardType()">
                                    <option value="">Selecciona el tipo</option>
                                    <option value="debit">Tarjeta de Débito</option>
                                    <option value="credit">Tarjeta de Crédito</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Número de Tarjeta</label>
                                <input type="text" id="cardNumber" class="form-control" placeholder="1234 5678 9012 3456" maxlength="19" oninput="formatCardNumber(event)" onblur="validateCardNumber()">
                                <small id="cardNumberError" style="color: var(--danger-color); display: none;"></small>
                                <div id="cardTypeIcon" style="margin-top: 0.5rem; font-size: 1.5rem;"></div>
                            </div>
                            <div class="form-grid" style="grid-template-columns: 1fr 1fr; gap: 1rem;">
                                <div class="form-group">
                                    <label>Fecha de Expiración</label>
                                    <input type="text" id="cardExpiry" class="form-control" placeholder="MM/AA" maxlength="5" oninput="formatExpiry(event)" onblur="validateExpiry()">
                                    <small id="expiryError" style="color: var(--danger-color); display: none;"></small>
                                </div>
                                <div class="form-group">
                                    <label>CVV</label>
                                    <input type="text" id="cardCVV" class="form-control" placeholder="123" maxlength="4" oninput="validateCVV(event)" onblur="validateCVVInput()">
                                    <small id="cvvError" style="color: var(--danger-color); display: none;"></small>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Nombre del Titular (como aparece en la tarjeta)</label>
                                <input type="text" id="cardHolder" class="form-control" placeholder="NOMBRE APELLIDO" style="text-transform: uppercase;" oninput="this.value = this.value.toUpperCase()">
                            </div>
                            <div class="security-notice" style="background: rgba(37, 99, 235, 0.05); padding: 1rem; border-radius: var(--radius-md); margin-bottom: 1rem; border-left: 3px solid var(--primary-color);">
                                <i class="fas fa-shield-alt" style="color: var(--primary-color); margin-right: 0.5rem;"></i>
                                <small style="color: var(--text-secondary);">
                                    <strong>Seguridad:</strong> Tu información de tarjeta está encriptada y nunca se almacena completamente. Solo guardamos los últimos 4 dígitos para identificación.
                                </small>
                            </div>
                            <button class="btn btn-primary" onclick="verifyCreditCard()">
                                <i class="fas fa-credit-card"></i> Verificar Tarjeta
                            </button>
                            <div id="cardVerificationStatus" style="margin-top: 1rem;"></div>
                        </div>
                    </div>
                </div>

            </div>

            <!-- Verification Complete -->
            <div class="verification-complete" id="verificationComplete" style="display: none;">
                <div class="complete-icon">
                    <i class="fas fa-check-circle"></i>
                </div>
                <h2>¡Verificación Completada!</h2>
                <p>Tu identidad ha sido verificada exitosamente. Ya puedes participar en rifas y retirar premios.</p>
                <button class="btn btn-primary" onclick="window.location.href='index.html'">
                    <i class="fas fa-home"></i> Volver al Inicio
                </button>
            </div>
        </section>
    </main>

    <script src="js/main.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/verificacion-identidad.js"></script>
</body>
</html>

